{% extends 'base.html' %}
{% load static %}

{% block title %}Search Properties - Home Finder{% endblock %}

{% block hero-image-content %}
<!-- Hero Section with Search -->
<section class="relative bg-gradient-to-br from-primary-600 via-primary-700 to-primary-800 overflow-hidden">
    <!-- Decorative elements -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary-500/20 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-coral-500/10 rounded-full blur-3xl"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-white/5 rounded-full blur-3xl"></div>
    </div>

    <div class="relative container-app py-12 md:py-16 lg:py-20">
        <div class="text-center max-w-3xl mx-auto mb-10 animate-fade-in-up">
            <h1 class="font-display text-display-lg md:text-display-xl text-white mb-4">
                Find Your Perfect Property
            </h1>
            <p class="text-lg md:text-xl text-primary-100 leading-relaxed">
                Search over 400,000 properties in Pinellas County with real-time data from official county records.
            </p>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="-mt-20 relative z-10 pb-8">
    <!-- Search Form Card -->
    <form method="post" action="{% url 'scraper' %}" id="search-form" data-loading-form class="card shadow-soft-xl max-w-4xl mx-auto">
        {% csrf_token %}

        <!-- Form Header -->
        <div class="card-header bg-gradient-to-r from-charcoal-50 to-white">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div>
                    <h2 class="font-display text-lg font-semibold text-charcoal-800">Property Search</h2>
                    <p class="text-sm text-charcoal-500">Filter properties by location, price, and features</p>
                </div>
            </div>
        </div>

        <div class="card-body space-y-8">

            <!-- Location Section -->
            <div class="animate-fade-in-up stagger-1">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h3 class="font-display font-semibold text-charcoal-800">Location</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- City Select -->
                    <div>
                        <label for="city" class="label">City</label>
                        <select id="city" name="city" class="select">
                            <option value="">All Cities</option>
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- ZIP Code -->
                    <div>
                        <label for="zip_code" class="label">ZIP Code</label>
                        <input type="text"
                               id="zip_code"
                               name="zip_code"
                               class="input"
                               placeholder="e.g., 33755"
                               pattern="337[0-8][0-9]"
                               maxlength="5">
                        <p class="helper-text">Pinellas County ZIP codes (337xx)</p>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Property Type Section -->
            <div class="animate-fade-in-up stagger-2">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <h3 class="font-display font-semibold text-charcoal-800">Property Type</h3>
                </div>

                <div class="flex flex-wrap gap-2" id="property-type-chips">
                    {% for ptype in property_types %}
                    <label class="chip cursor-pointer transition-all duration-200 hover:shadow-soft-sm">
                        <input type="checkbox" name="property_type" value="{{ ptype }}" class="sr-only peer">
                        <span class="peer-checked:bg-primary-500 peer-checked:text-white peer-checked:border-primary-500 rounded-full px-4 py-2 border border-charcoal-200 bg-white transition-all duration-200">
                            {{ ptype }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="divider"></div>

            <!-- Price Range Section -->
            <div class="animate-fade-in-up stagger-3">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="font-display font-semibold text-charcoal-800">Price Range</h3>
                    </div>
                    <span class="text-sm font-medium text-primary-600" id="price-range-display">$0 - $2,000,000+</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="min_value" class="label">Minimum Price</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-charcoal-400">$</span>
                            <input type="number"
                                   id="min_value"
                                   name="min_value"
                                   class="input pl-8"
                                   placeholder="0"
                                   min="0"
                                   step="10000"
                                   onchange="updatePriceDisplay()">
                        </div>
                    </div>
                    <div>
                        <label for="max_value" class="label">Maximum Price</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-charcoal-400">$</span>
                            <input type="number"
                                   id="max_value"
                                   name="max_value"
                                   class="input pl-8"
                                   placeholder="No limit"
                                   min="0"
                                   step="10000"
                                   onchange="updatePriceDisplay()">
                        </div>
                    </div>
                </div>

                <!-- Quick Price Buttons -->
                <div class="flex flex-wrap gap-2 mt-3">
                    <button type="button" onclick="setPrice(0, 200000)" class="badge badge-neutral hover:bg-charcoal-200 cursor-pointer transition-colors">Under $200k</button>
                    <button type="button" onclick="setPrice(200000, 400000)" class="badge badge-neutral hover:bg-charcoal-200 cursor-pointer transition-colors">$200k - $400k</button>
                    <button type="button" onclick="setPrice(400000, 600000)" class="badge badge-neutral hover:bg-charcoal-200 cursor-pointer transition-colors">$400k - $600k</button>
                    <button type="button" onclick="setPrice(600000, 1000000)" class="badge badge-neutral hover:bg-charcoal-200 cursor-pointer transition-colors">$600k - $1M</button>
                    <button type="button" onclick="setPrice(1000000, null)" class="badge badge-neutral hover:bg-charcoal-200 cursor-pointer transition-colors">$1M+</button>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Bedrooms & Bathrooms Section -->
            <div class="animate-fade-in-up stagger-4">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <h3 class="font-display font-semibold text-charcoal-800">Bedrooms & Bathrooms</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bedrooms -->
                    <div>
                        <label class="label">Bedrooms (minimum)</label>
                        <div class="flex gap-2" id="bedroom-buttons">
                            <button type="button" data-value="" class="bed-btn btn btn-secondary btn-sm active">Any</button>
                            <button type="button" data-value="1" class="bed-btn btn btn-secondary btn-sm">1+</button>
                            <button type="button" data-value="2" class="bed-btn btn btn-secondary btn-sm">2+</button>
                            <button type="button" data-value="3" class="bed-btn btn btn-secondary btn-sm">3+</button>
                            <button type="button" data-value="4" class="bed-btn btn btn-secondary btn-sm">4+</button>
                            <button type="button" data-value="5" class="bed-btn btn btn-secondary btn-sm">5+</button>
                        </div>
                        <input type="hidden" name="bedrooms_min" id="bedrooms_min" value="">
                    </div>

                    <!-- Bathrooms -->
                    <div>
                        <label class="label">Bathrooms (minimum)</label>
                        <div class="flex gap-2" id="bathroom-buttons">
                            <button type="button" data-value="" class="bath-btn btn btn-secondary btn-sm active">Any</button>
                            <button type="button" data-value="1" class="bath-btn btn btn-secondary btn-sm">1+</button>
                            <button type="button" data-value="2" class="bath-btn btn btn-secondary btn-sm">2+</button>
                            <button type="button" data-value="3" class="bath-btn btn btn-secondary btn-sm">3+</button>
                            <button type="button" data-value="4" class="bath-btn btn btn-secondary btn-sm">4+</button>
                        </div>
                        <input type="hidden" name="bathrooms_min" id="bathrooms_min" value="">
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Additional Filters (Collapsible) -->
            <div class="animate-fade-in-up stagger-5">
                <button type="button"
                        onclick="toggleAdvanced()"
                        class="flex items-center gap-2 text-charcoal-600 hover:text-primary-600 transition-colors duration-200">
                    <svg id="advanced-icon" class="w-5 h-5 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                    <span class="font-medium">More Filters</span>
                </button>

                <div id="advanced-filters" class="hidden mt-4 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Year Built -->
                        <div>
                            <label for="year_built_after" class="label">Year Built (after)</label>
                            <input type="number"
                                   id="year_built_after"
                                   name="year_built_after"
                                   class="input"
                                   placeholder="e.g., 2000"
                                   min="1900"
                                   max="2024">
                        </div>

                        <!-- Tax Status -->
                        <div>
                            <label for="tax_status" class="label">Tax Status</label>
                            <select id="tax_status" name="tax_status" class="select">
                                <option value="">All Properties</option>
                                <option value="Paid">Taxes Paid</option>
                                <option value="Unpaid">Taxes Unpaid</option>
                                <option value="Delinquent">Tax Delinquent</option>
                            </select>
                        </div>
                    </div>

                    <!-- Square Footage -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="sqft_min" class="label">Min Square Feet</label>
                            <input type="number"
                                   id="sqft_min"
                                   name="sqft_min"
                                   class="input"
                                   placeholder="e.g., 1000"
                                   min="0"
                                   step="100">
                        </div>
                        <div>
                            <label for="sqft_max" class="label">Max Square Feet</label>
                            <input type="number"
                                   id="sqft_max"
                                   name="sqft_max"
                                   class="input"
                                   placeholder="No limit"
                                   min="0"
                                   step="100">
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Search Limit -->
            <div class="animate-fade-in-up stagger-6">
                <div class="flex items-center justify-between">
                    <div>
                        <label for="limit" class="label mb-0">Results Limit</label>
                        <p class="text-sm text-charcoal-500">Maximum properties to retrieve</p>
                    </div>
                    <select id="limit" name="limit" class="select w-32">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

        </div>

        <!-- Form Footer with Submit -->
        <div class="card-footer">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <button type="button" onclick="resetForm()" class="btn btn-ghost text-charcoal-600">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Reset Filters</span>
                </button>

                <button type="submit" data-loading-text="Searching..." class="btn btn-primary btn-lg group w-full sm:w-auto">
                    <svg class="w-5 h-5 transition-transform duration-200 group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span>Search Properties</span>
                </button>
            </div>
        </div>
    </form>

    <!-- Trust Signals -->
    <div class="max-w-4xl mx-auto mt-8 text-center animate-fade-in stagger-6">
        <div class="flex flex-wrap justify-center items-center gap-6 text-sm text-charcoal-500">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-success-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>Official County Data</span>
            </div>
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-success-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>400,000+ Properties</span>
            </div>
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-success-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>Real-time Tax Data</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    // Price display update
    function updatePriceDisplay() {
        const min = document.getElementById('min_value').value;
        const max = document.getElementById('max_value').value;
        const display = document.getElementById('price-range-display');

        const formatPrice = (val) => {
            if (!val) return null;
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
        };

        const minFormatted = formatPrice(min) || '$0';
        const maxFormatted = formatPrice(max) || 'No limit';

        display.textContent = `${minFormatted} - ${maxFormatted}`;
    }

    // Quick price buttons
    function setPrice(min, max) {
        document.getElementById('min_value').value = min || '';
        document.getElementById('max_value').value = max || '';
        updatePriceDisplay();
    }

    // Bedroom buttons
    document.querySelectorAll('.bed-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.bed-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-secondary');
            });
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');
            document.getElementById('bedrooms_min').value = this.dataset.value;
        });
    });

    // Bathroom buttons
    document.querySelectorAll('.bath-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.bath-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-secondary');
            });
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');
            document.getElementById('bathrooms_min').value = this.dataset.value;
        });
    });

    // Toggle advanced filters
    function toggleAdvanced() {
        const filters = document.getElementById('advanced-filters');
        const icon = document.getElementById('advanced-icon');
        filters.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }

    // Reset form
    function resetForm() {
        document.getElementById('search-form').reset();

        // Reset bedroom buttons
        document.querySelectorAll('.bed-btn').forEach((btn, i) => {
            btn.classList.toggle('btn-primary', i === 0);
            btn.classList.toggle('btn-secondary', i !== 0);
        });
        document.getElementById('bedrooms_min').value = '';

        // Reset bathroom buttons
        document.querySelectorAll('.bath-btn').forEach((btn, i) => {
            btn.classList.toggle('btn-primary', i === 0);
            btn.classList.toggle('btn-secondary', i !== 0);
        });
        document.getElementById('bathrooms_min').value = '';

        // Reset price display
        document.getElementById('price-range-display').textContent = '$0 - No limit';

        // Hide advanced filters
        document.getElementById('advanced-filters').classList.add('hidden');
        document.getElementById('advanced-icon').classList.remove('rotate-180');
    }

    // Form validation
    document.getElementById('search-form').addEventListener('submit', function(e) {
        const minPrice = parseInt(document.getElementById('min_value').value) || 0;
        const maxPrice = parseInt(document.getElementById('max_value').value) || Infinity;

        if (minPrice > maxPrice && maxPrice !== Infinity) {
            e.preventDefault();
            window.Toast.warning('Minimum price cannot be greater than maximum price.');
            return false;
        }

        const minSqft = parseInt(document.getElementById('sqft_min').value) || 0;
        const maxSqft = parseInt(document.getElementById('sqft_max').value) || Infinity;

        if (minSqft > maxSqft && maxSqft !== Infinity) {
            e.preventDefault();
            window.Toast.warning('Minimum square footage cannot be greater than maximum.');
            return false;
        }
    });

    // Initial state for bedroom/bathroom buttons
    document.querySelector('.bed-btn').classList.add('btn-primary');
    document.querySelector('.bed-btn').classList.remove('btn-secondary');
    document.querySelector('.bath-btn').classList.add('btn-primary');
    document.querySelector('.bath-btn').classList.remove('btn-secondary');
</script>
{% endblock %}
